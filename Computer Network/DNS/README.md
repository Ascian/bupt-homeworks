# bupt_computer-network-course-design_Dnsrelay
## 系统功能设计
* 本功能：开启DNS服务器时，读入“域名-IP地址”对照表，当客户端查询域名对应的IP地址时，用域名检索该对照表。若结果为IP地址0.0.0.0，则向客户端返回NAMEERROR报错信息；若结果为普通IP地址，则向客户返回这个地址；若表中未找到该域名，则向主机DNS服务器发出查询，并将结果返回给客户端。
* 多客户端并发：采用多线程结构，DNS服务器程序每接收到一个查询或者主机DNS回答，创建一个新线程处理数据，防止等待数据造成的CPU闲置。若需要转发查询，将消息ID改为线程对应序号，并保存原ID，当收到主机DNS消息时，依据ID找到对应线程，修改为原ID后发送消息给客户端并释放线程资源。
* 超时处理：设置较长的超时时限，若程序超时未接收到主机DNS信息，直接释放线程资源，不对客户端做任何回应，将超时透明传递给客户端；若程序在超时后收到主机DNS信息且消息ID对应的线程已被另一个客户端查询占用，发送回答给该客户端，该客户端依据错误ID丢弃回答。
* 缓存功能：采用自定义红黑树实现快速查询实现时间复杂度为O(logn)的增删查改，采用自定义双向链表实现LRU机制。程序读入“域名-IP地址”对照表时，将该表项设置为静态数据加入红黑树。当客户端查询的域名需要转发给主机DNS服务器时，收到主机DNS回答后，将回答中的A和AAAA类型数据设置为动态数据后加入红黑树，并插入双向链表表头，若链表大小超过指定容量，删除表尾数据。若客户端查询的域名在红黑树中有对应表数据，返回对应数据，若为动态数据，将该数据插入双向链表表头。

由于可能存在域名更换，域名不再使用的情况，动态缓存会定时清空。

允许一个域名保存多个A或AAAA类型IP地址，对于MX、CNAME等其他类型的查询不做缓存只进行转发。

动态缓存只存于内存中，不保存到存有静态数据的文件，避免污染静态数据。

## 运行

命令行界面输入

dnsrelay[-d|-dd] [dns-server-ipaddr] [filename]

* dnsrelay

无调试信息输出

使用默认名字服务器202.106.0.20

使用默认配置文件(当前目录下dnsrelay.txt)

* dnsrelay –d  192.168.0.1  c:\dns-table.txt

调试信息级别1（仅输出时间坐标，序号，客户端IP地址，查询的域名）

使用指定的名字服务器192.168.0.1

使用指定的配置文件c:\dns-table.txt

* dnsrelay –dd  202.99.96.68 

调试信息级别2 （输出冗长的调试信息）

使用指定的名字服务器202.99.96.68使用默认配置文件(当前目录下dnsrelay.txt)
